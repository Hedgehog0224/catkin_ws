# Интерфейсы передачи данных

Что нужно, чтобы передать информацию и понять её содержимое? Сама информация, отправитель, получатель, способ её кодировки и кодировки, канал передачи данных. Этому нехитрому правилу подчиняется даже человеческая речь - в ней отправителем и получателем являются собеседники, кодируется и декодируется информация при помощи языка (оговорённого списка символов, слов и правил общения), а каналом передачи - связка голос-слух.

Такая же ситуация с передачей данных в любой цифровой электронике. Для передачи данных применяются такие понятия, как **Протокол** и **Шина**:
- **Протокол передачи данных** - перечень правил, определяющий особенности и порядок передачи данных;
- **Компьютерная шина** - соединение, предназначенное для передачи данных между функциональными блоками компьютера.

Получается, что протокол отвечает за кодировку и декодировку информации, шина является каналом передачи. А вот отправителем и поолучателем могут быть любые компоненты, связанные между собой шиной, между которыми можно передавать данные, соответствующие протоколу.

Как будет происходить передача данных в цифровой электронике?\
Данные закодированы в двоичной системе счисления и передаются при помощи логических уровней напряжения. Необходимо их передать в одну сторону по одному проводу. Можно просто пустить поток бит, настроив скорость передачи и приёма данных одинаково для отправителя и приёмника. Но, принимающее устройство не сможет определить, где у потока начало, а где конец, идёт ли передача вообще, как биты распределены по байтам и т.д.

Для этого применяются такие протоколы передачи данны, как **UART** и **I2C**.


## UART
`Universal Asynсhronous Receiver-Transmitter` (*Универсльный асинхронный приёмопередатчик*) - это  и протокол передачи данных и аппаратное устройство (или схема), используемое для последовательной связи между двумя устройствами.

Термин **асинхронный** означает, что прием и передача отдельных битов не выравниваются так называемыми синхроимпульсами.\
Чем хороша асинхронная передача данных? Простотой протокола, минимумом проводов и занятых в процессе аппаратных средств, возможность полного дуплекса (одновременной передачи данных в обоих направлениях).\
В чем ее недостаток? Меньшая помехозащищенность и, как следствие, максимальная скорость и расстояние при тех же остальных условиях. 

### Принцип действия
Если рассматривать **UART** как протокол, то он работает путём преобразования данных в пакеты для отправки или восстановления данных из полученных пакетов.\
Данные состоят из следующих элементов:
- **Стартовый бит** (логические **0** и **1**, соответственно);
- **Биты данных**;
- **Бит чётности**;
- **Стоп-бит**.


К примеру, необходимо передать файл, размерностью 8 бит.\
Принято считать, что пассивным состоянием (в отсутствие потока данных) входа и выхода протокола является логическая единица. Стартовый бит всегда является логическим нулём (**0**), поэтому приёмник UART ждёт перепада из **1** в **0** и отсчитывает от него временной промежуток в половину длительности бита (т.е. середина передачи стартового бита). Если в этот момент на входе всё ещё логический ноль, то запускается процесс приёма минимальной посылки. Для этого приёмник отсчитывает 10 битовых длительностей подряд, и в каждый момент фиксирует состояние входа. Первые 8 бит являются **битами данных**, затем один **бит чётности**. При приёме посылки автоматически подсчитывается число единичных бит в посылке, включая бит чётности. Если чётность нарушена, то при передаче допущена ошибка. Последний, проверочный **стоповый бит**, всегда равен единице (**1**). Если значение последнего иное, то фиксируется ошибка.\
Такой подход позволяет организовать устойчивую однонаправленную передачу данных по одному проводу.

![Image_0](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-00.png)\
*Без бита чётности*

![Image_2](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-02.png)\
*С битом чётности*

### Подключение
Если рассматривать **UART** на физическом уровне, то для корректной работы шины необходимо правильно осуществить подключение.

Схема подключения выглядит следующим образом:
- **TX-контакт** - предназначен для передачи данных;
- **RX-контакт** - предназначен для приёма данных;
- Подключение происходит по схеме **TX-->RX** в обе стороны (**UART1->UART2** и **UART2->UART1**).

![Image_1](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-01.png)


### Отправка данных
Перед отправкой, передающее устройство преобразует байты данных в биты. После, разбивает их на пакеты для передачи. Каждый пакет содержит **стартовый бит**, **блок данных**, **бит чётности** и **стоп-биты**.

### Приём данных
Принимающее устройство проверяет принятый пакет (через вывод **RX**) на наличие ошибок, вычисляя число единиц и сравнивая его со значением бита чётности, содержащегося в пакете.\
При отсутствии ошибок, осуществляется переход к обработке **стартового бита**, **стоповых битов**, **бита чётности**. Есть вероятность, что необходимо получить несколько пакетов, прежде чем пересобрать весь байт данных из фреймов данных. После восстановления байт сохраняется в буфере UART.\
Принимающее устройство использует бит чётности для определения факта потери данных при передаче. Потеря данных происходит при изменении битом чётности своего состояния при передаче. Причина потери данных - расстояние передачи, магнитное излучение, несовпадение скоростей передачи и прочее.


### Параметры UART
Чтобы иметь правильную связь, настройки **UART** должны быть одинаковыми на обоих устройствах:

1. Скорость передачи.
Количество бит в секунду, которое может передавать или получать устройство UART. Для правильной передачи, необходимо соответствие значений скорости в бодах у обеих устройств UART.\
Распространённые значения скорости передачи данных:
    - 9600 бит в секунду;
    - 1200 бит в секунду;
    - 2400 бит в секунду;
    - 4800 бит в секунду;
    - 19200 бит в секунду;
    - 38400 бит в секунду;
    - 57600 бит в секунду;
    - 115200 бит в секунду.

2. Длина данных.
Чётко задано количество **битов данных** (блок данных) в пределах одной передачи (символа). Количество от 5 до 9 бит.

3. Бит чётности
Бит, добавляемый к передаваемым данным и сообщающий приемнику, является ли число единиц в передаваемых данных нечётным (**ODD**) или чётным (**EVEN**). Предназначен для определения факта потери данных при передаче (потери происходят, когда бит чётности меняет своё состояние при передаче):
    - **ODD** - Чётность. Бит четности равен '1', если в данных присутствует нечётное число логических единиц. В противном случае бит четности устанавливается равным нулю.   
    - **EVEN** - бит четности равен '1', если в данных присутствует четное число логических единиц. В противном случае бит четности устанавливается равным нулю.

4. Количество стоп-битов\
Приборы UART могут использовать ни одного, один или два стоповых бита для маркировки конца переданного набора битов (так называемых пакетов).

5. Управение потоком\
**Flow Control** (управление потоком) - метод, позволяющий избежать риска потери данных при передаче данных через UART. В устройстве UART в качестве управления потоком для запуска/остановки передачи данных используются специальные символы.


### Материалы по UART:
- __https://ru.wikipedia.org/wiki/Универсальный_асинхронный_приёмопередатчик__;
- __https://habr.com/ru/articles/708902/__;
- __https://habr.com/ru/articles/109395/__;
- __https://3d-diy.ru/wiki/arduino-moduli/interfeys-peredachi-dannykh-uart/__.




## I2C
`Inter-Integrated Circuit` - последовательная ассиметричная шина для связи между интегральными схемами внутри электронных приборов. Использует две двунаправленные линии связи (**SDA** и **SCL**) и применяется для соединения никоскоростных перефирийных компонентов с процессорами и микроконтроллерами.\
В отличие от UART, I2C является протоколом **синхронной** связи. Это значит, что обмен данными происходит по общему для всех связанных устройств сигналу синхронизации. Также, I2C отличается от UART более высокой скоростью стабильной передачи данных и более стабильной передачей данных на высокой скорости.\
Кроме того, благодаря своей архитектуре, позволяет подключать к одной шине, состоящей из двух проводов **SDA** (данные) и **SCL** (тактовые импульсы), до 127 устройств одновременно, не используя дополнительного оборудования, если не считать двух подтягивающих резисторов.


### Принцип действия
Шина использует две двунаправленные линии, подтянутые к напряжению через резисторы и управляемые через открытый коллектор или открытый сток:
- **SDA** (Serial DAta) - последовательная линия данных;
- **SCL** (Serial CLock) - последовательная линия тактирования.

Максимальное напряжение +5 В, часто используется +3,3 В, однако допускаются и другие напряжения (не менее 2 В).

Есть ведущий (Master) и ведомые (Slave). Инициатором обмена всегда выступает ведущий, обмен между двумя ведомыми невозможен. Всего на одной двухпроводной шине может быть до 127 устройств.\
Все ведомые устройства имеют уникальный номер, даже если такое устройство на всю сеть одно. Ведущее устройство номера не имеет.\
Такты на линии **SCL** генерирует Master. Линией **SDA** могут управлять как Master, так и Slave в зависимости от направления передачи.

![Image_3](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-03.jpg)

Единицей обмена информации является пакет, обрамленный уникальными условиями на шине, именуемыми стартовым и стоповым условиями. Мастер в начале каждого пакета передает один байт, где указывает адрес ведомого и направление передачи последующих данных. Данные передаются 8-битными словами. После каждого слова передается один бит подтверждения приема приемной стороной.

![Image_5](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-05.jpg)

Вследствие различных технологий микросхем (КМОП, НМОП, биполярная), которые могут быть подключены к шине, уровни логического **0** (LOW) и логической **1** (HIGH) не фиксированы и зависят от соответствующего уровня **Vdd**. Один синхроимпульс генерируется на каждый пересылаемый бит.\
Данные на линии **SDA** (линия данных) должны быть стабильными в течение HIGH-периода синхроимпульса. HIGH-состояние или LOW-состояние **SDA** (линия данных) должно меняться, только если **SCL** (линия синхронизации) в состоянии LOW.


**Таблица 1 - Термины**
| Термин-англ       | Термин-рус    | Описание  |
|-------------------|---------------|-------------------------------------------------------------------------------------------------------|
| Transmitter	    | Передатчик	| Устройство, посылающее данные в шину                                                                  |
| Receiver		    | Приёмник	    | Устройство, принимающее с шины                                                                        |
| Master			| Ведущий	    | Начинает пересылку данных, вырабатывает синхроимпульсы, заканчивает пересылку данных                  |
| Slave			    | Ведомый	    | Устройство, адресуемое ведущим                                                                        |
| Multi-master		| ----------	| Несколько ведущих могут пытаться захватить шину одновременно, без нарушения передаваемой информации   |
| Arbitration		| Арбитраж	    | Процедура, обеспечивающая Multi-master                                                                |
| Synchronization	| Синхронизация	| Процедура синхронизации двух устройств                                                                |


### Начало и завершение обмена данными
Обмен данными, как уже было сказано, инициируется ведущим устройством (**Master**). Оно генерирует тактирующие сигналы на линии **SCL**, которые имеют определенную периодичность, но могут быть задержаны приемником (**Slave**), если он еще не готов принят следующий байт данных.\
В исходном состоянии обе линии **SDA** и **SCL** находятся в высоком состоянии. Процедура обмена данными начинается с формирования ведущим устройством состояния **СТАРТ**: переход состояния линии **SDA** с высокого на низкое при высоком состоянии на линии **SCL**.
Процедура обмена данными заканчивается, когда ведущий формирует состояние **СТОП**: переход состояния линии **SDA** с низкого на высокое при высоком состоянии на линии **SCL**.

![Image_4](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-04.jpg)

### Обмен данными
Данные передаются изменением уровня сигнала на линии **SDA** в определенной последовательности. Обмен данными происходит байтами, каждый из которых состоит из 8 бит. За один сеанс может быть передано неограниченное количество байт.\
После формирования состояния **СТАРТ** и до появления состояния **СТОП** изменять уровень на линии **SDA** можно только при **низком** состоянии на тактирующей линии **SCL**. Бит информации «читается» приёмником только когда на линии **SCL** установлен **высокий** уровень сигнала, поэтому в этот момент на линии **SDA** сигнал должен быть неизменным и стабильным. Принятые данные считаются действительными, только если соблюдается это правило.

![Image_6](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-06.jpg)

### Подтверждение приема данных
Для корректной передачи данных, приемник должен подтверждать прием каждого байта от передатчика. Для этого в спецификации протокола обмена по шине **I2C** вводится специальный **бит подтверждения**, выставляемый приёмником на шину **SDA** после приема каждого 8-го бита данных.\
Передача каждых 8-ми **бит данных** считается успешной, если приемник отправляет **бит подтверждения** с низкий уровень сигнала по линии **SDA**. Импульс синхронизации для **подтверждающего бита** генерируется ведущим устройством сразу после переданных 8-ми **бит данных**.

![Image_7](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-07.jpg)

### Адресация
Логично, что перед обменом данными ведущее устройство должно определить с каким ведомым устройством планируется работа в этом сеансе. Т.е. **ведущий** должен адресовать необходимого **ведомого**, «позвать его по имени». Для этого **Master**, сразу после установки состояния **СТАРТ**, отправляет по шине специальный байт информации, первые 7 бит которого содержат **адрес** **Slave** (в обычном режиме), а 8-й бит (**бит направления**) — информацию о направлении передачи.\
Как уже отмечалось выше, каждое устройство в шине **I2C** должно иметь уникальный адрес, но также в системе предусмотрен адрес «общего вызова» для обращения ко всем ведомым сразу. Адрес ведомого может состоять из фиксированной и программируемой частей. После отправки адресного байта по шине, каждое устройство в системе сравнивает первые семь бит после сигнала **СТАРТ** со своим адресом.\
Если адреса совпали, устройство считает себя выбранным как *ведомый-приёмник* или как *ведомый-передатчик*, в зависимости от состояния бита направления:
- **низкий уровень** (**0**) означает, что ведущий будет отправлять информацию ведомому;
- **высокий** (**1**) означает, что ведущий будет получать информацию от ведомого.
Из спецификации шины следует, что допускаются не только простые форматы обмена, но и комбинированные, когда в промежутке от состояния СТАРТ до состояния СТОП ведущий и ведомый могут выступать и как приемник и как передатчик данных. Комбинированные форматы могут быть использованы, например, для управления последовательной памятью.

![Image_8](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-08.jpg)

![Image_9](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/Folder-3-4/003-4-09.jpg)


### Материалы по I2C:
- __https://ru.wikipedia.org/wiki/I%C2%B2C__;
- __https://ampermarket.kz/base/i2c_interface/__;
- __https://3d-diy.ru/wiki/arduino-moduli/interfeys-peredachi-dannykh-i2c/__;