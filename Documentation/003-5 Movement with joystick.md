# Управление движением робота при помощи джойстика (связь между джойстиком и главной нодой)

## 1. Как задаётся управление роботом при помощи кнопок
Библиотека **ros-noetic-joy** содержит ноду **joy_node**, в которой каждая кнопка джойстика пронумерована - им присвоены свои числа в сообщении. Ниже дана таблица, в которой перечислены некоторые кнопки с соответствующей нумерацией:


**Таблица 1 - Нумерация назначения кнопок в сообщении Joy**
| Номер | Название      | 
|:-----:|---------------|
| 0     | L3-horizontal |
| 1     | *L3-vertical?*|
| 2     | R2            |
| 3     | R3-horizontal |
| 4     | R3-vertical   |
| 5     | L2            |

*Выделенные курсивом не используются в роботе изначально.*

![Image_1](https://github.com/Hedgehog0224/catkin_ws/blob/docs/Documentation/Images/003-5-1.jpg)
### Изображение 1 - Наименование кнопок джойстика (003-5-1.jpg)

Издатель-нода **choseMode** получает данные от джойстика, публикует сообщения типа **xy** в топик **Mode** (т.е., только те данные, которые указаны в **xy.msg**) в виде параметров объектов класса **chooseModeClass.msg.x**, **chooseModeClass.msg.y**, **chooseModeClass.msg.anlge**, **chooseModeClass.msg.mode**.\
Далее, подписчик-главная нода **shim_cringe** получает данные от топика, в ней значения рабиваются на отельные элементы **x**, **y**, **angle**, **mode**.

Сообщение **xy.msg** состоит из 4 переменных нескольких типов:


**Таблица 2 - Типы переменных сообщения**
| Номер | Тип       | Переменная    | Значение переменной                       |
|:-----:|-----------|---------------|-------------------------------------------|
| 1     | float64   | x             | координата x с правого стика              |
| 2     | float64   | y             | координата y с правого стика              |
| 3     | float64   | angle         | угол (скорость) поворота с левого стика   |
| 4     | int8      | mode          | режим (зависит от нажатых кнопок)         |

Можно расширить список переменных, описанных в **xy.msg** для расширения функционала кнопок джойстика - добавить новые переменные в файл и ноду.\
Со списоком встроенных типов можно ознакомиться по сслыке: __https://wiki.ros.org/msg__.


## 2. Изменение назначения существующих кнопок, добавление новых
Нумерация позволяет без проблем задать связь между кнопкой (стиком)/комбинацией кнопок и одиним или несколькими алгоритмами действия. Ниже указан шаблон для присвоения кнопке алгоритма. В ноде джойстика **chooseMode** уже заданы связи 4-х алгоритмов для кнопок и стиков (начало - строка **20**). Добавление новых связей может быть между строками **25** и **26**:
```
elif data.axes[x] < y:       
    chooseModeClass.msg.mode = z
```
Где:
- **x** - Номер кнопки;
- **y** - Условие проверки состояния кнопки (нажата или нет);
- **z** - Значение переменной **chooseModeClass.msg.mode** при выполнении условия.

### 2.1 Изменение назначения кнопок
Для этого необходимо изменить значение **x** на любое, описанное в Таблице 1. В  функции **callback_joy()** ноды **chooseMode** можно менять любые числовые значения внутри или любой **data.axes[]** заменить на **data.buttons[]** (первое - кнопки D-Pad, L1, L2, R1, R2, R3 и L3 как стики; второе - Select, Start, PS, Triangle, Circle, X, Square, R3 И L3 как кнопки).\
Например, можно изменить значение с **0** на **1** (строка **29**):
```
chooseModeClass.msg.angle = data.axes[0]    ->    chooseModeClass.msg.angle = data.axes[1]
```
Или:
```
chooseModeClass.msg.angle = data.axes[0]    ->    chooseModeClass.msg.angle = data.buttons[0]
```

### 2.1 Добавление новых кнопок
Чтобы добавить новую кнопку, необходимо:
1. Изменение сообщения (добавление новых элементов в файл **xy.msg**);
2. Добавление нового кода в издатель-ноду (**chooseMode.py**) для корректного формирования нового сообщения;
3. Добавление нового кода в подписчик-ноду (**shim_cringe.py**) для обработки нового сообщения и формирования новых паттернов поведения.

Например:
1. В файле **xy.msg** добавить элемент:
```
Header header
float64 x
float64 y
float64 angle
int8 mode
string name
```

2. В файле **chooseMode.py**, в методе **callback_joy()** (со строки **17**) присваиваем новому параметру значение:
```
chooseModeClass.msg.name = 'cringe'
```

3. В файле **shim_cringe.py**:
    - Создаём переменную класса **robotcl()** (со строки **26**):
    ```
    name = ''
    ```
    - В методе **callback_scan()** (со строки **53**) добавляем логгирование (при работе будет выводится заданное в **chooseMode.py** значение):
    ```
    rospy.loginfo("Name: %s", robotcl.name)
    ```
    - В методе **callback_mode()** (со строки **123**) присваиваем значение переменной класса из топика:
    ```
    robotcl.name = data.name
    ```